name: âœˆï¸ Preflight Tests

on:
  push:
    branches: [dev, main]
  pull_request:
    branches: [dev, main]

jobs:
  # ============================================
  # Frontend Tests - Vitest (Vue/JS unit tests)
  # ============================================
  frontend-tests:
    name: ğŸ§ª Frontend Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ—‚ Checkout Code
        uses: actions/checkout@v6

      - name: ğŸ§© Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24.x"

      - name: ğŸ“¦ Install PNPM
        run: npm i pnpm -g

      - name: ğŸ—ƒ Cache node_modules Directory
        uses: actions/cache@v4
        id: node_modules-cache
        with:
          path: node_modules
          key: ${{ runner.OS }}-node_modules-cache-${{ hashFiles('**/package.json') }}-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: ğŸš€ Install NPM Packages
        if: steps.node_modules-cache.outputs.cache-hit != 'true'
        run: pnpm i

      - name: ğŸ§ª Execute Vue/JS tests via Vitest
        run: pnpm test:run

  # ============================================
  # Frontend Build - Vite compilation check
  # ============================================
  frontend-build:
    name: ğŸ— Frontend Build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ—‚ Checkout Code
        uses: actions/checkout@v6

      - name: ğŸ˜ Install PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.5"

      - name: ğŸ—‚ Cache PHP Dependencies
        uses: actions/cache@v4
        id: vendor-cache
        with:
          path: vendor
          key: ${{ runner.OS }}-vendor-${{ hashFiles('**/composer.lock') }}

      - name: ğŸ“¦ Install Composer Dependencies
        if: steps.vendor-cache.outputs.cache-hit != 'true'
        run: composer install --no-interaction --prefer-dist --no-scripts --ignore-platform-reqs

      - name: ğŸ§© Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24.x"

      - name: ğŸ“¦ Install PNPM
        run: npm i pnpm -g

      - name: ğŸ—ƒ Cache node_modules Directory
        uses: actions/cache@v4
        id: node_modules-cache
        with:
          path: node_modules
          key: ${{ runner.OS }}-node_modules-cache-${{ hashFiles('**/package.json') }}-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: ğŸš€ Install NPM Packages
        if: steps.node_modules-cache.outputs.cache-hit != 'true'
        run: pnpm i

      - name: ğŸ— Build Frontend with Vite
        run: pnpm build

      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: public/build
          retention-days: 1

  # ============================================
  # Backend Tests - Pest (PHP tests)
  # ============================================
  backend-tests:
    name: ğŸ˜ Backend Tests
    needs: frontend-build
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_DB: preflight_laravel_app
          POSTGRES_USER: preflight_laravel_app
          POSTGRES_PASSWORD: preflight_laravel_app
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=3

      redis:
        image: redis:latest
        ports:
          - 6330:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: ğŸ—‚ Checkout Code
        uses: actions/checkout@v6

      - name: ğŸ—ƒ Setup Cache Environment
        id: extcache
        uses: shivammathur/cache-extensions@v1
        with:
          php-version: 8.5
          extensions: bcmath
          key: php_extensions_cache

      - name: ğŸ—ƒ Cache Extensions
        uses: actions/cache@v4
        with:
          path: ${{ steps.extcache.outputs.dir }}
          key: ${{ steps.extcache.outputs.key }}
          restore-keys: ${{ steps.extcache.outputs.key }}

      - name: ğŸ˜ Install PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.5"
          extensions: bcmath

      - name: ğŸ—‚ Cache PHP Dependencies
        uses: actions/cache@v4
        id: vendor-cache
        with:
          path: vendor
          key: ${{ runner.OS }}-vendor-${{ hashFiles('**/composer.lock') }}

      - name: ğŸ“‹ Copy .env
        run: php -r "file_exists('.env') || copy('.env.example', '.env');"

      - name: ğŸ“¦ Install Composer Dependencies
        if: steps.vendor-cache.outputs.cache-hit != 'true'
        run: composer install --no-interaction --prefer-dist

      - name: ğŸ”§ Directory Permissions
        run: chmod -R 777 storage bootstrap/cache

      - name: ğŸ”‘ Generate App Key
        run: php artisan key:generate

      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: public/build

      - name: ğŸ”„ Run Migrations
        env:
          DB_CONNECTION: pgsql
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          DB_DATABASE: preflight_laravel_app
          DB_USERNAME: preflight_laravel_app
          DB_PASSWORD: preflight_laravel_app
          REDIS_HOST: 127.0.0.1
          REDIS_PORT: 6330
        run: php artisan migrate:fresh --seed

      - name: ğŸ§ª Execute tests (Unit and Feature tests) via Pest
        env:
          DB_CONNECTION: pgsql
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          DB_DATABASE: preflight_laravel_app
          DB_USERNAME: preflight_laravel_app
          DB_PASSWORD: preflight_laravel_app
          REDIS_HOST: 127.0.0.1
          REDIS_PORT: 6330
        run: vendor/bin/pest --testdox
